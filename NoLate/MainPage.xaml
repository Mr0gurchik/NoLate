<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:NoLate.Models"
             xmlns:toolkit="clr-namespace:CommunityToolkit.Maui.Behaviors;assembly=CommunityToolkit.Maui"
             x:Class="NoLate.MainPage"
             Shell.NavBarIsVisible="False"
             BackgroundColor="{StaticResource Background}">

    <ContentPage.Behaviors>
        <toolkit:StatusBarBehavior 
            StatusBarColor="Transparent" 
            StatusBarStyle="LightContent" />
    </ContentPage.Behaviors>

    <Grid RowDefinitions="*, Auto" Padding="20" Margin="0,40,0,0">

        <!-- Список -->
            <CollectionView x:Name="AlarmsCollection"
                        Grid.Row="0"
                        SelectionMode="None">

                <!-- Пустой список -->
                <CollectionView.EmptyView>
                    <VerticalStackLayout Spacing="10"
                                         Padding="20"
                                         HorizontalOptions="Center"
                                         VerticalOptions="Center">
                        <Label Text="Пока нет будильников. Повезло..."
                               TextColor="{StaticResource OnSurface}"
                               FontSize="16"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:AlarmModel">
                        <Border Padding="15"
                                StrokeShape="RoundRectangle 12"
                                BackgroundColor="{StaticResource Surface}">

                        <!-- Стиль для подсветки -->
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="StrokeThickness" Value="2" />
                                <Setter Property="Margin" Value="0,6" />
                                <Setter Property="Stroke" Value="#40E0E0E0" />

                                <Style.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
                                        <Setter Property="Stroke" Value="#FF8C00" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>

                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnAlarmItemTapped" CommandParameter="{Binding .}"/>
                        </Border.GestureRecognizers>

                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto">

                                <!-- Адрес -->
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="{Binding Mesto}"
                                       FontAttributes="Bold"
                                       FontSize="16"
                                       TextColor="{StaticResource OnSurface}" />

                                <!-- Время прибытия -->
                                <Label Grid.Row="1" Grid.Column="0"
                                       Text="{Binding MestTime, StringFormat='{0:dd.MM    HH:mm}'}"
                                       FontSize="14"
                                       TextColor="{StaticResource Primary}" />

                                <!-- В пути -->
                                <Label Grid.Row="2" Grid.Column="0"
                                       Text="{Binding TravelTimeText}"
                                       FontSize="12"
                                       TextColor="{StaticResource Primary}" />

                            <!-- Время будильника -->
                                <Label Grid.Row="0" Grid.Column="1"
                                       Grid.RowSpan="2"
                                       Text="{Binding AlarmTime, StringFormat='{0:HH:mm}'}"
                                       FontSize="24"
                                       FontAttributes="Bold"
                                       TextColor="{StaticResource Primary}"
                                       HorizontalTextAlignment="End" />

                                <!-- Свич -->
                                <Switch Grid.Row="2" Grid.Column="1"
                                        IsToggled="{Binding IsActive, Mode=TwoWay}"
                                        Toggled="OnSwitchToggled"
                                        OnColor="#FF8C00"
                                        ThumbColor="White"
                                        HorizontalOptions="End" />

                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        
        <!-- Кнопка добавления -->
        <ImageButton Grid.Row="1"
             Source="add_button.png"
             BackgroundColor="Transparent"
             HeightRequest="80"
             HorizontalOptions="Fill" 
             Margin="40,15,40,20"
             Aspect="AspectFit"
             Clicked="OnAddClicked" />
        
        <!-- Кастомное меню что бы оно распологалась по центру экрана ну и впринципе это лучше можно хоть редачить-->
        <Grid x:Name="ActionMenuOverlay"
             Grid.Row="0" Grid.RowSpan="2"
             ZIndex="100"  
             IsVisible="False"
             Opacity="0">

            <!-- Так ну закрытие при клацание мимо -->
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnOverlayTapped"/>
            </Grid.GestureRecognizers>

            <BoxView Color="{StaticResource Background}" Opacity="0.8" />

            <Border Stroke="{StaticResource Primary}"
                StrokeThickness="1"
                BackgroundColor="#1E1E1E"
                StrokeShape="RoundRectangle 20"
                WidthRequest="300"
                VerticalOptions="Center"
                HorizontalOptions="Center"
                Padding="20">

                <VerticalStackLayout Spacing="15">
                    <!-- Заголовок -->
                    <Label x:Name="MenuTitleLabel"
                       Text="Куда едем?"
                       TextColor="White"
                       FontSize="18"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"/>

                    <BoxView Color="#333" HeightRequest="1" />

                    <!-- Кнопка Редактировать -->
                    <Button Text="Редактировать ✏️"
                        BackgroundColor="#333"
                        TextColor="White"
                        CornerRadius="10"
                        Clicked="OnEditMenuClicked"/>

                    <!-- Кнопка Удалить -->
                    <Button Text="Удалить 🗑️"
                        BackgroundColor="#3E1010"
                        TextColor="#FF4444"
                        CornerRadius="10"
                        Clicked="OnDeleteMenuClicked"/>

                    <!-- Кнопка Отмена -->
                    <Button Text="Отмена"
                        BackgroundColor="Transparent"
                        TextColor="#888"
                        Clicked="OnOverlayTapped"/>
                </VerticalStackLayout>
            </Border>
        </Grid>
        
    </Grid>
</ContentPage>
